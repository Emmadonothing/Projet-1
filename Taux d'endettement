-- taux d'endettement 
SELECT 
    c.customerNumber,
    c.customerName,
    c.city,
    c.country,
    c.salesRepEmployeeNumber,
    c.creditLimit,
    COALESCE(SUM(od.quantityOrdered * od.priceEach), 0) AS totalPurchases,
    COALESCE(p.totalPayments, 0) AS totalPayments,
    ROUND(
        CASE 
            WHEN COALESCE(p.totalPayments, 0) > 0 
            THEN ((COALESCE(SUM(od.quantityOrdered * od.priceEach), 0) / COALESCE(p.totalPayments, 0)) * 100) - 100
            ELSE 0 
        END
    , 0) AS debtRatio
FROM 
    customers c
LEFT JOIN 
    orders o 
ON 
    c.customerNumber = o.customerNumber
LEFT JOIN 
    orderdetails od 
ON 
    o.orderNumber = od.orderNumber
LEFT JOIN 
    (
        SELECT 
            customerNumber, 
            SUM(amount) AS totalPayments
        FROM 
            payments
        GROUP BY 
            customerNumber
    ) p 
ON 
    c.customerNumber = p.customerNumber
GROUP BY 
    c.customerNumber, 
    c.customerName, 
    c.city, 
    c.country
ORDER BY 
    debtRatio DESC;
